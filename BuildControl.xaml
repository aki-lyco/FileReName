<UserControl x:Class="Explore.BuildControl"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:build="clr-namespace:Explore.Build"
             mc:Ignorable="d"
             d:DesignWidth="1100" d:DesignHeight="700">

	<!-- コメントは連続ハイフンを含めない（== を使用） -->
	<UserControl.Resources>
		<BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>

		<Style x:Key="ToolbarButton" TargetType="Button">
			<Setter Property="Margin" Value="4"/>
			<Setter Property="Padding" Value="8,4"/>
			<Setter Property="MinWidth" Value="110"/>
		</Style>

		<!-- ツリーの表示 -->
		<HierarchicalDataTemplate DataType="{x:Type build:CategoryNode}" ItemsSource="{Binding Children}">
			<StackPanel Orientation="Horizontal" Margin="2">
				<TextBlock Text="📁" Margin="0,0,6,0" VerticalAlignment="Center"/>
				<TextBlock Text="{Binding Display}" VerticalAlignment="Center"/>
				<TextBlock Text=" 🔒" Foreground="DarkGray" Margin="6,0,0,0"
                           Visibility="{Binding IsRequired, Converter={StaticResource BooleanToVisibilityConverter}}"/>
			</StackPanel>
		</HierarchicalDataTemplate>
	</UserControl.Resources>

	<Grid>
		<Grid.RowDefinitions>
			<RowDefinition Height="Auto"/>
			<RowDefinition Height="*"/>
			<RowDefinition Height="Auto"/>
		</Grid.RowDefinitions>

		<!-- == ツールバー == -->
		<ToolBarTray Grid.Row="0">
			<ToolBar>
				<TextBlock Text="保存先: " VerticalAlignment="Center" Margin="4,0"/>
				<!-- ★ 読み取り専用プロパティなので OneWay を明示 -->
				<TextBlock Text="{Binding BaseDisplay, Mode=OneWay}" VerticalAlignment="Center"/>
				<Separator/>
				<Button Style="{StaticResource ToolbarButton}" Content="保存先フォルダを選択" Command="{Binding PickBasePath}"/>
				<Button Style="{StaticResource ToolbarButton}" Content="自動取り込み" Command="{Binding AutoImportFromBase}"/>
				<Separator/>
				<Button Style="{StaticResource ToolbarButton}" Content="検証" Command="{Binding ValidateCategories}"/>
			</ToolBar>
		</ToolBarTray>

		<!-- == 本体 == -->
		<Grid Grid.Row="1">
			<!-- == SelectTargets 画面 == -->
			<Grid x:Name="SelectView">
				<Grid.Style>
					<Style TargetType="Grid">
						<Setter Property="Visibility" Value="Collapsed"/>
						<Style.Triggers>
							<DataTrigger Binding="{Binding State}" Value="{x:Static build:BuildState.SelectTargets}">
								<Setter Property="Visibility" Value="Visible"/>
							</DataTrigger>
						</Style.Triggers>
					</Style>
				</Grid.Style>

				<Border Margin="12" BorderBrush="#DDD" BorderThickness="1" CornerRadius="8" Padding="24" Background="#FAFAFA">
					<StackPanel HorizontalAlignment="Center" VerticalAlignment="Center" Width="640">
						<TextBlock Text="分類対象を追加してください" FontSize="18" FontWeight="Bold" Margin="0,0,0,12"/>
						<TextBlock Text="ファイル/フォルダをここにドラッグ＆ドロップするか、ボタンから選択します。" Margin="0,0,0,16"/>
						<StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
							<Button Content="ファイルを追加" Margin="4" Padding="12,6" Click="OnAddFilesClick"/>
							<Button Content="フォルダを追加" Margin="4" Padding="12,6" Click="OnAddFolderClick"/>
							<Button Content="次へ（設計へ）" Margin="16,4" Padding="16,6" Command="{Binding DecideTargets}"/>
						</StackPanel>

						<!-- ▼ 選択済み一覧 -->
						<GroupBox Margin="0,24,0,0">
							<GroupBox.Header>
								<DockPanel LastChildFill="False">
									<TextBlock Text="選択済み" VerticalAlignment="Center"/>
									<StackPanel Orientation="Horizontal" DockPanel.Dock="Right">
										<Button Content="選択を削除" Click="OnRemoveSelectedTargets" Margin="6,0,0,0" Padding="8,2"/>
										<Button Content="クリア"     Click="OnClearTargets"          Margin="6,0,0,0" Padding="8,2"/>
									</StackPanel>
								</DockPanel>
							</GroupBox.Header>

							<ListBox x:Name="SelectedList"
									 ItemsSource="{Binding SelectedTargets}"
									 Height="220"
									 SelectionMode="Extended"
									 KeyDown="SelectedList_KeyDown">
								<ListBox.ContextMenu>
									<ContextMenu>
										<MenuItem Header="選択を削除" Click="OnRemoveSelectedTargets"/>
										<MenuItem Header="全クリア"   Click="OnClearTargets"/>
									</ContextMenu>
								</ListBox.ContextMenu>
							</ListBox>
						</GroupBox>
						<!-- ▲ 選択済み一覧 -->
					</StackPanel>
				</Border>
			</Grid>

			<!-- == Design 画面 == -->
			<Grid x:Name="DesignView">
				<Grid.Style>
					<Style TargetType="Grid">
						<Setter Property="Visibility" Value="Collapsed"/>
						<Style.Triggers>
							<DataTrigger Binding="{Binding State}" Value="{x:Static build:BuildState.Design}">
								<Setter Property="Visibility" Value="Visible"/>
							</DataTrigger>
						</Style.Triggers>
					</Style>
				</Grid.Style>

				<Grid.ColumnDefinitions>
					<ColumnDefinition Width="3*"/>
					<ColumnDefinition Width="4*"/>
					<ColumnDefinition Width="4*"/>
				</Grid.ColumnDefinitions>

				<!-- 左：ツリー -->
				<Border Grid.Column="0" Margin="8" BorderBrush="#DDD" BorderThickness="1" CornerRadius="6">
					<DockPanel>
						<StackPanel DockPanel.Dock="Top" Orientation="Horizontal" Margin="8">
							<TextBlock Text="カテゴリ（仮想）" FontWeight="Bold" VerticalAlignment="Center"/>
							<Button Content="＋ ルート直下に追加" Margin="12,0,0,0" Command="{Binding AddRootCategory}"/>
							<Button Content="＋ 子を追加" Margin="6,0,0,0" Command="{Binding AddCategory}"/>
						</StackPanel>

						<TreeView x:Name="Tree"
                                  ItemsSource="{Binding Root.Children}"
                                  SelectedItemChanged="Tree_SelectedItemChanged"
                                  AllowDrop="True">
							<TreeView.Resources>
								<ContextMenu x:Key="TreeContextMenu">
									<MenuItem Header="子を追加" Command="{Binding DataContext.AddCategory, RelativeSource={RelativeSource AncestorType=TreeView}}"/>
									<MenuItem Header="名前変更（表示名→相対に反映）" Command="{Binding DataContext.RenameCategory, RelativeSource={RelativeSource AncestorType=TreeView}}"/>
									<MenuItem Header="削除" Command="{Binding DataContext.RemoveCategory, RelativeSource={RelativeSource AncestorType=TreeView}}"/>
									<Separator/>
									<MenuItem Header="このフォルダを開く" Command="{Binding DataContext.OpenCategoryInExplorer, RelativeSource={RelativeSource AncestorType=TreeView}}"/>
								</ContextMenu>
							</TreeView.Resources>
							<TreeView.ItemContainerStyle>
								<Style TargetType="TreeViewItem">
									<Setter Property="ContextMenu" Value="{StaticResource TreeContextMenu}"/>
								</Style>
							</TreeView.ItemContainerStyle>
						</TreeView>
					</DockPanel>
				</Border>

				<!-- 中央：詳細 -->
				<Border Grid.Column="1" Margin="8" BorderBrush="#DDD" BorderThickness="1" CornerRadius="6" Padding="8">
					<Grid>
						<Grid.Style>
							<Style TargetType="Grid">
								<Setter Property="IsEnabled" Value="True"/>
								<Style.Triggers>
									<DataTrigger Binding="{Binding SelectedCategory}" Value="{x:Null}">
										<Setter Property="IsEnabled" Value="False"/>
									</DataTrigger>
									<!-- 未分類は編集不可 -->
									<DataTrigger Value="True">
										<DataTrigger.Binding>
											<Binding Path="SelectedCategory.IsRequired" TargetNullValue="False" FallbackValue="False"/>
										</DataTrigger.Binding>
										<Setter Property="IsEnabled" Value="False"/>
									</DataTrigger>
								</Style.Triggers>
							</Style>
						</Grid.Style>

						<Grid.RowDefinitions>
							<RowDefinition Height="Auto"/>
							<RowDefinition Height="Auto"/>
							<RowDefinition Height="Auto"/>
							<RowDefinition Height="Auto"/>
							<RowDefinition Height="*"/>
						</Grid.RowDefinitions>

						<TextBlock Text="詳細" FontWeight="Bold" FontSize="14"/>

						<!-- 表示名 -->
						<Grid Grid.Row="1" Margin="0,8,0,0">
							<Grid.ColumnDefinitions>
								<ColumnDefinition Width="Auto"/>
								<ColumnDefinition Width="*"/>
							</Grid.ColumnDefinitions>
							<TextBlock Text="表示名:" VerticalAlignment="Center" Margin="0,0,8,0"/>
							<TextBox Grid.Column="1"
                                     Text="{Binding SelectedCategory.Display, UpdateSourceTrigger=PropertyChanged, TargetNullValue='', FallbackValue=''}"/>
						</Grid>

						<!-- 相対パス（読み取り専用） -->
						<Grid Grid.Row="2" Margin="0,8,0,0">
							<Grid.ColumnDefinitions>
								<ColumnDefinition Width="Auto"/>
								<ColumnDefinition Width="*"/>
							</Grid.ColumnDefinitions>
							<TextBlock Text="相対パス:" VerticalAlignment="Center" Margin="0,0,8,0"/>
							<TextBox Grid.Column="1"
                                     IsReadOnly="True"
                                     Background="Transparent"
                                     BorderBrush="#CCC"
                                     Text="{Binding SelectedCategory.RelPath, Mode=OneWay, TargetNullValue='', FallbackValue=''}"/>
						</Grid>

						<!-- キーワード -->
						<Grid Grid.Row="3" Margin="0,8,0,0">
							<Grid.ColumnDefinitions>
								<ColumnDefinition Width="Auto"/>
								<ColumnDefinition Width="*"/>
							</Grid.ColumnDefinitions>
							<TextBlock Text="キーワード(JSONまたは,区切り):" VerticalAlignment="Center" Margin="0,0,8,0"/>
							<TextBox Grid.Column="1"
                                     Text="{Binding SelectedCategory.KeywordsJson, UpdateSourceTrigger=PropertyChanged, TargetNullValue='', FallbackValue=''}"/>
						</Grid>

						<!-- 拡張子/AIヒント -->
						<Grid Grid.Row="4" Margin="0,8,0,0">
							<Grid.RowDefinitions>
								<RowDefinition Height="Auto"/>
								<RowDefinition Height="Auto"/>
							</Grid.RowDefinitions>
							<Grid.ColumnDefinitions>
								<ColumnDefinition Width="Auto"/>
								<ColumnDefinition Width="*"/>
							</Grid.ColumnDefinitions>

							<TextBlock Grid.Row="0" Grid.Column="0" Text="拡張子フィルタ:" VerticalAlignment="Center" Margin="0,0,8,0"/>
							<TextBox   Grid.Row="0" Grid.Column="1"
                                       Text="{Binding SelectedCategory.ExtFilter, UpdateSourceTrigger=PropertyChanged, TargetNullValue='', FallbackValue=''}"/>

							<TextBlock Grid.Row="1" Grid.Column="0" Text="AIヒント:" VerticalAlignment="Center" Margin="0,8,8,0"/>
							<TextBox   Grid.Row="1" Grid.Column="1"
                                       Text="{Binding SelectedCategory.AiHint, UpdateSourceTrigger=PropertyChanged, TargetNullValue='', FallbackValue=''}"/>
						</Grid>
					</Grid>
				</Border>

				<!-- 右：選択対象一覧（置き換え） -->
				<Border Grid.Column="2" Margin="8" BorderBrush="#DDD" BorderThickness="1" CornerRadius="6" Padding="8">
					<StackPanel>
						<TextBlock Text="選択対象（ファイル/フォルダ）" FontWeight="Bold"/>
						<ListBox x:Name="SelectedListDesign"
								 ItemsSource="{Binding SelectedTargets}"
								 Height="360"
								 SelectionMode="Extended"
								 KeyDown="SelectedList_KeyDown">
							<ListBox.ContextMenu>
								<ContextMenu>
									<MenuItem Header="選択を削除" Click="OnRemoveSelectedTargets"/>
									<MenuItem Header="全クリア"   Click="OnClearTargets"/>
								</ContextMenu>
							</ListBox.ContextMenu>
						</ListBox>

						<TextBlock Text="しきい値" Margin="0,12,0,4"/>
						<Slider Minimum="0" Maximum="1" Value="{Binding AiThreshold}" TickFrequency="0.05" IsSnapToTickEnabled="True"/>
						<StackPanel Orientation="Horizontal" Margin="0,8,0,0">
							<Button Content="適用テスト（ドライラン）" Command="{Binding RunDryRun}" Margin="0,0,8,0"/>
							<Button Content="戻る" Command="{Binding BackToSelectTargets}"/>
						</StackPanel>
					</StackPanel>
				</Border>
			</Grid>

			<!-- == DryRunPreview 画面（実装） == -->
			<Border x:Name="DryRunView">
				<Border.Style>
					<Style TargetType="Border">
						<Setter Property="Visibility" Value="Collapsed"/>
						<Style.Triggers>
							<DataTrigger Binding="{Binding State}" Value="{x:Static build:BuildState.DryRunPreview}">
								<Setter Property="Visibility" Value="Visible"/>
							</DataTrigger>
						</Style.Triggers>
					</Style>
				</Border.Style>

				<ScrollViewer Margin="12">
					<StackPanel>
						<TextBlock Text="DryRunプレビュー" FontSize="18" FontWeight="Bold"/>
						<TextBlock Margin="0,6,0,10">
							<Run Text="保存先: "/>
							<Run Text="{Binding BaseDisplay, Mode=OneWay}"/>
						</TextBlock>

						<Border BorderBrush="#DDD" BorderThickness="1" CornerRadius="6" Padding="10" Background="#FAFAFA" Margin="0,0,0,10">
							<StackPanel Orientation="Horizontal">
								<TextBlock Text="{Binding Plan.Stats.CreateCount, StringFormat=作成フォルダ: {0}}" Margin="0,0,16,0"/>
								<TextBlock Text="{Binding Plan.Stats.MoveCount, StringFormat=移動: {0}}" Margin="0,0,16,0"/>
								<TextBlock Text="{Binding Plan.Stats.UnresolvedCount, StringFormat=未分類: {0}}" Margin="0,0,16,0"/>
								<TextBlock Text="{Binding Plan.Stats.ErrorCount, StringFormat=エラー: {0}}"/>
							</StackPanel>
						</Border>

						<GroupBox Header="作成フォルダ" Margin="0,0,0,10">
							<ItemsControl ItemsSource="{Binding Plan.CreateDirs}">
								<ItemsControl.ItemTemplate>
									<DataTemplate>
										<TextBlock Text="{Binding RelPath}"/>
									</DataTemplate>
								</ItemsControl.ItemTemplate>
							</ItemsControl>
						</GroupBox>

						<GroupBox Header="移動プラン">
							<DataGrid ItemsSource="{Binding Plan.Moves}"
                                      AutoGenerateColumns="False"
                                      CanUserAddRows="False"
                                      IsReadOnly="True"
                                      Height="360"
                                      Margin="0,4,0,0">
								<DataGrid.Columns>
									<DataGridTextColumn Header="元の場所" Binding="{Binding SourceFullPath}" Width="*"/>
									<DataGridTextColumn Header="移動先"   Binding="{Binding DestFullPath}"   Width="*"/>
									<DataGridTextColumn Header="理由"     Binding="{Binding Reason}"         Width="140"/>
								</DataGrid.Columns>
							</DataGrid>
						</GroupBox>

						<StackPanel Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,12,0,0">
							<Button Content="テストやり直し" Command="{Binding RunDryRun}" Margin="0,0,8,0"/>
							<Button Content="適用を実行"     Command="{Binding ApplyPlan}" Margin="0,0,8,0"/>
							<Button Content="設計に戻る"     Command="{Binding BackToDesign}"/>
						</StackPanel>

					</StackPanel>
				</ScrollViewer>
			</Border>
		</Grid>

		<!-- == ステータスバー == -->
		<StatusBar Grid.Row="2">
			<StatusBarItem>
				<TextBlock Text="{Binding Status}"/>
			</StatusBarItem>
		</StatusBar>
	</Grid>
</UserControl>
