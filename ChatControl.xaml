<UserControl x:Class="Explore.ChatControl"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:local="clr-namespace:Explore"
             mc:Ignorable="d" 
             d:DesignHeight="450" d:DesignWidth="800">

    <UserControl.Resources>
        <DataTemplate x:Key="UserTemplate">
            <Border Background="#DCF8C6" CornerRadius="10" Padding="10" Margin="50,5,0,5"
                    HorizontalAlignment="Right" MaxWidth="500">
                <TextBlock Text="{Binding Content}" TextWrapping="Wrap" FontSize="14"/>
            </Border>
        </DataTemplate>

        <DataTemplate x:Key="AITemplate">
            <Border Background="#E6E6E6" CornerRadius="10" Padding="10" Margin="0,5,50,5"
                    HorizontalAlignment="Left" MaxWidth="500">
                <TextBlock Text="{Binding Content}" TextWrapping="Wrap" FontSize="14"/>
            </Border>
        </DataTemplate>

        <local:ChatMessageTemplateSelector x:Key="MessageTemplateSelector"
                                           UserTemplate="{StaticResource UserTemplate}"
                                           AITemplate="{StaticResource AITemplate}" />
    </UserControl.Resources>

    <Grid Grid.IsSharedSizeScope="True">
        <Grid.RowDefinitions>
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*"/>
            <ColumnDefinition Width="2*" SharedSizeGroup="ViewWidth"/>
            <ColumnDefinition Width="*"/>
            <ColumnDefinition Width="{x:Static SystemParameters.VerticalScrollBarWidth}" />
        </Grid.ColumnDefinitions>

        <!-- メッセージ一覧 -->
        <ScrollViewer x:Name="ChatScrollViewer"
                      Grid.Row="0" Grid.Column="0" Grid.ColumnSpan="4" Grid.RowSpan="2" Panel.ZIndex="0"
                      VerticalScrollBarVisibility="Visible"
                      ScrollChanged="ChatScrollViewer_ScrollChanged" Padding="0,0,0,45">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="2*" SharedSizeGroup="ViewWidth"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>
                <StackPanel Grid.Column="1">
                    <ItemsControl x:Name="ChatList"
                                  ItemTemplateSelector="{StaticResource MessageTemplateSelector}">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <StackPanel />
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                    </ItemsControl>

                    <Rectangle Height="100" Fill="Transparent"/>
                </StackPanel>
            </Grid>
        </ScrollViewer>

        <Button x:Name="ScrollDownButton" Click="ScrollDownButton_Click" Grid.Row="0" Grid.Column="1"
                FontFamily="Segoe Fluent Icons" Content="&#xF0AE;" FontSize="14"
                Width="32" Height="32" Panel.ZIndex="1" Margin="0,0,0,5"
                Visibility="Collapsed"
                HorizontalAlignment="Center" VerticalAlignment="Bottom" Cursor="Hand">
            <Button.Template>
                <ControlTemplate TargetType="Button">
                    <Grid>
                        <Ellipse Fill="White" Stroke="#FFE6E6E6"/>
                        <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center" />
                    </Grid>
                </ControlTemplate>
            </Button.Template>
        </Button>

        <!-- 入力欄と送信ボタン -->

        <Border Grid.Row="1" Grid.Column="1" Padding="10" Margin="0,0,0,20" CornerRadius="28" 
                Background="White" BorderThickness="1" BorderBrush="#FFB0B0B0" 
                MouseDown="InputFocus" Cursor="IBeam"
                MaxHeight="414" MaxWidth="1280" MinWidth="700" Panel.ZIndex="1" >
            <Border.Effect>
                <DropShadowEffect BlurRadius="6"
                                  ShadowDepth="3"
                                  Direction="270"
                                  Opacity="0.1"/>
            </Border.Effect>
            <!--MaxWidth:1152px-->
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <TextBox x:Name="InputBox" PreviewKeyDown="EnterSend" MinHeight="48" MinWidth="100" 
                         Grid.Row="0" Grid.Column="0" Grid.ColumnSpan="3"
                        FontSize="16" Padding="0,12,0,12" BorderThickness="0" Margin="12,0,12,0" TextWrapping="Wrap" />
                <Button FontFamily="Segoe Fluent Icons" Content="&#xF8AA;" FontSize="14"
                        Width="36" Height="36" Grid.Row="1" Grid.Column="0"
                        Click="SendButton_Click" Cursor="Hand" ToolTip="ファイルを追加する" >
                    <Button.Template>
                        <ControlTemplate TargetType="Button">
                            <Grid>
                                <Ellipse x:Name="circle" Fill="White"/>
                                <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center" />
                            </Grid>
                            <ControlTemplate.Triggers>
                                <Trigger Property="IsMouseOver" Value="True">
                                    <Setter TargetName="circle" Property="Fill" Value="#FFFAFAFA"/>
                                </Trigger>
                            </ControlTemplate.Triggers>
                        </ControlTemplate>
                    </Button.Template>
                </Button>
                <Button FontFamily="Segoe Fluent Icons" Content="&#xF0AD;" FontSize="14" Foreground="White"
                        Width="36" Height="36" Grid.Row="1" Grid.Column="2"
                        Click="SendButton_Click" Cursor="Hand" >
                    <Button.Template>
                        <ControlTemplate TargetType="Button">
                            <Grid>
                                <Ellipse x:Name="circle" Fill="Black"/>
                                <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center" />
                            </Grid>
                            <ControlTemplate.Triggers>
                                <Trigger Property="IsMouseOver" Value="True">
                                    <Setter TargetName="circle" Property="Fill" Value="#FF4C4C4C"/>
                                </Trigger>
                            </ControlTemplate.Triggers>
                        </ControlTemplate>
                    </Button.Template>
                </Button>
            </Grid>
        </Border>
    </Grid>
</UserControl>
