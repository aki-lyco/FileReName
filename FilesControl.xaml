<UserControl x:Class="Explore.FilesControl"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:local="clr-namespace:Explore"
             xmlns:fs="clr-namespace:Explore.FileSystem"
             mc:Ignorable="d"
             d:DesignHeight="600" d:DesignWidth="1000">

	<UserControl.Resources>
		<!-- パンくず -->
		<local:PathToBreadcrumbConverter x:Key="PathToBreadcrumb" />

		<!-- DataGrid の行スタイル -->
		<Style TargetType="{x:Type DataGridRow}">
			<Setter Property="Padding" Value="10,2"/>
			<Setter Property="BorderBrush" Value="#EEE"/>
			<Setter Property="BorderThickness" Value="0,0,0,1"/>
		</Style>

		<!-- 行右クリックメニュー -->
		<ContextMenu x:Key="FilesRowMenu">
			<MenuItem Header="開く" Tag="OpenFile" CommandParameter="{Binding FullPath}" />
			<MenuItem Header="場所を開く" Tag="OpenLocation" CommandParameter="{Binding FullPath}" />
			<Separator/>
			<MenuItem Header="差分のみ Index（このファイル）" Tag="ReindexFile" CommandParameter="{Binding FullPath}" />
			<MenuItem Header="DBレコード削除" Tag="DeleteDbRecord" CommandParameter="{Binding FullPath}" />
			<Separator/>
			<MenuItem Header="ゴミ箱に移動" Tag="DeleteFile" CommandParameter="{Binding FullPath}" />
		</ContextMenu>

		<!-- フォルダツリーの右クリックメニュー -->
		<ContextMenu x:Key="FolderTreeMenu">
			<MenuItem Header="ゴミ箱に移動" Tag="DeleteFolder" CommandParameter="{Binding FullPath}" />
		</ContextMenu>

		<Style TargetType="{x:Type TreeViewItem}" x:Key="FolderTreeItemStyle">
			<Setter Property="Padding" Value="6,2"/>
			<Setter Property="IsExpanded" Value="False"/>
			<Setter Property="ContextMenu" Value="{StaticResource FolderTreeMenu}" />
		</Style>
	</UserControl.Resources>

	<Grid>
		<Grid.RowDefinitions>
			<RowDefinition Height="Auto"/>
			<RowDefinition Height="Auto"/>
			<RowDefinition Height="*"/>
		</Grid.RowDefinitions>

		<!-- ツールバー -->
		<Border Grid.Row="0" Background="#F6F7F9" Padding="8,8" BorderBrush="#E6E6E6" BorderThickness="0,0,0,1">
			<StackPanel Orientation="Horizontal">
				<Button x:Name="BtnNewCreate" Content="新規作成" Padding="12,6" Margin="0,0,8,0"/>
				<Separator Width="8"/>
				<Button x:Name="BtnIndex" Content="このフォルダを同期" Padding="12,6" Margin="0,0,8,0"/>
				<Button x:Name="BtnIndexDiff" Content="差分のみIndex" Padding="12,6" Margin="0,0,8,0"/>
				<Button x:Name="BtnRecycle" Content="ゴミ箱へ移動" Padding="12,6" Margin="0,0,8,0"/>
				<TextBlock Text="{Binding IndexStatusText}" Margin="16,0,0,0" VerticalAlignment="Center" Foreground="#666"/>
				<TextBlock Text="{Binding FreshnessPercent, StringFormat=鮮度\ {0:F0}%}" Margin="8,0,0,0" VerticalAlignment="Center" Foreground="#666"/>
			</StackPanel>
		</Border>

		<!-- パンくず -->
		<Border Grid.Row="1" Background="#FAFAFA" Padding="8,6" BorderBrush="#E6E6E6" BorderThickness="0,0,0,1" Margin="0,0,0,6">
			<ScrollViewer HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Disabled">
				<ItemsControl ItemsSource="{Binding VM.CurrentPath, Converter={StaticResource PathToBreadcrumb}}">
					<ItemsControl.ItemsPanel>
						<ItemsPanelTemplate>
							<StackPanel Orientation="Horizontal"/>
						</ItemsPanelTemplate>
					</ItemsControl.ItemsPanel>
					<ItemsControl.ItemTemplate>
						<DataTemplate DataType="{x:Type local:BreadcrumbItem}">
							<StackPanel Orientation="Horizontal">
								<Button Padding="10,4" Margin="0,0,2,0"
                                        Background="Transparent" BorderBrush="Transparent"
                                        Content="{Binding Name}"
                                        Tag="{Binding FullPath}"
                                        Click="OnBreadcrumbClick" />
								<TextBlock x:Name="Chevron" Text="›" Foreground="#9AA0A6"
                                           VerticalAlignment="Center" Margin="2,0"/>
							</StackPanel>
							<DataTemplate.Triggers>
								<DataTrigger Binding="{Binding IsLast}" Value="True">
									<Setter TargetName="Chevron" Property="UIElement.Visibility" Value="Collapsed"/>
								</DataTrigger>
							</DataTemplate.Triggers>
						</DataTemplate>
					</ItemsControl.ItemTemplate>
				</ItemsControl>
			</ScrollViewer>
		</Border>

		<!-- 本文 -->
		<Grid Grid.Row="2">
			<Grid.ColumnDefinitions>
				<ColumnDefinition Width="280"/>
				<ColumnDefinition Width="4"/>
				<ColumnDefinition Width="*"/>
			</Grid.ColumnDefinitions>

			<!-- フォルダツリー -->
			<Border Grid.Column="0" BorderBrush="#E6E6E6" BorderThickness="0,0,1,0">
				<TreeView x:Name="FolderTree"
                          ItemsSource="{Binding VM.Roots}"
                          ItemContainerStyle="{StaticResource FolderTreeItemStyle}"
                          VirtualizingStackPanel.IsVirtualizing="True"
                          VirtualizingPanel.ScrollUnit="Item"
                          ScrollViewer.CanContentScroll="True">
					<TreeView.ItemTemplate>
						<HierarchicalDataTemplate DataType="{x:Type fs:FolderNode}" ItemsSource="{Binding Children}">
							<StackPanel Orientation="Horizontal">
								<TextBlock Text="📁" Margin="0,0,6,0"/>
								<TextBlock Text="{Binding Name}" />
							</StackPanel>
						</HierarchicalDataTemplate>
					</TreeView.ItemTemplate>
				</TreeView>
			</Border>

			<!-- 仕切り -->
			<GridSplitter Grid.Column="1"
                          HorizontalAlignment="Stretch" VerticalAlignment="Stretch"
                          Background="#F0F0F0" Width="4" ResizeBehavior="PreviousAndNext" />

			<!-- ファイル一覧 -->
			<Grid Grid.Column="2">
				<DataGrid x:Name="FilesGrid"
                          ItemsSource="{Binding Rows}"
                          AutoGenerateColumns="False"
                          HeadersVisibility="Column"
                          GridLinesVisibility="None"
                          CanUserAddRows="False"
                          SelectionMode="Extended"
                          EnableRowVirtualization="True"
                          EnableColumnVirtualization="True"
                          ScrollViewer.CanContentScroll="True"
                          RowHeaderWidth="0">
					<DataGrid.RowStyle>
						<Style TargetType="{x:Type DataGridRow}" BasedOn="{StaticResource {x:Type DataGridRow}}">
							<Setter Property="ContextMenu" Value="{StaticResource FilesRowMenu}" />
						</Style>
					</DataGrid.RowStyle>
					<DataGrid.Columns>
						<!-- 左端チェック列（ヘッダーで全選択/全解除） -->
						<DataGridTemplateColumn Width="40" IsReadOnly="False">
							<DataGridTemplateColumn.HeaderTemplate>
								<DataTemplate>
									<CheckBox HorizontalAlignment="Center" VerticalAlignment="Center"
                                              Click="OnHeaderCheckAllClick"/>
								</DataTemplate>
							</DataGridTemplateColumn.HeaderTemplate>
							<DataGridTemplateColumn.CellTemplate>
								<DataTemplate>
									<CheckBox IsChecked="{Binding IsChecked, Mode=TwoWay}"
                                              HorizontalAlignment="Center" VerticalAlignment="Center"/>
								</DataTemplate>
							</DataGridTemplateColumn.CellTemplate>
						</DataGridTemplateColumn>

						<DataGridTextColumn Header="名前" Binding="{Binding Name}" Width="*"/>
						<DataGridTextColumn Header="拡張子" Binding="{Binding Extension}" Width="120"/>
						<DataGridTextColumn Header="サイズ" Binding="{Binding Size, StringFormat={}{0:N0}}" Width="140"/>
						<DataGridTextColumn Header="更新日時" Binding="{Binding LastWriteTime, StringFormat={}{0:yyyy-MM-dd HH:mm}}" Width="180"/>
					</DataGrid.Columns>
				</DataGrid>
			</Grid>
		</Grid>
	</Grid>
</UserControl>
