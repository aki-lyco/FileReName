<UserControl x:Class="Explore.FilesControl"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:local="clr-namespace:Explore"
             xmlns:fs="clr-namespace:Explore.FileSystem"
             xmlns:conv="clr-namespace:FileReName.Converters"
             mc:Ignorable="d"
             d:DesignWidth="1200" d:DesignHeight="700">
	<UserControl.Resources>
		<BooleanToVisibilityConverter x:Key="BoolToVis"/>

		<!-- フォルダ階層テンプレート -->
		<HierarchicalDataTemplate DataType="{x:Type fs:FolderNode}"
								  ItemsSource="{Binding Children}">
			<TextBlock Text="{Binding Name}"/>
		</HierarchicalDataTemplate>

		<!-- 鮮度表示（外部コンバータ） -->
		<conv:FreshStateToGlyphConverter x:Key="FreshGlyph"/>
		<conv:FreshStateToBrushConverter x:Key="FreshBrush"/>
		<conv:FreshStateToTipConverter   x:Key="FreshTip"/>
	</UserControl.Resources>

	<Grid>
		<Grid.RowDefinitions>
			<RowDefinition Height="Auto"/>
			<RowDefinition Height="*"/>
		</Grid.RowDefinitions>
		<Grid.ColumnDefinitions>
			<ColumnDefinition Width="260"/>
			<ColumnDefinition Width="*"/>
		</Grid.ColumnDefinitions>

		<!-- 左ペイン：新規作成 -->
		<StackPanel Grid.Row="0" Grid.Column="0" Orientation="Horizontal" Margin="8,8,8,6">
			<Button x:Name="BtnNew" Content="新規作成" Padding="10,4" Click="OnNewButtonClick">
				<Button.ContextMenu>
					<ContextMenu>
						<MenuItem Header="フォルダー" Click="OnNewFolderClick"/>
						<Separator/>
						<MenuItem Header="テキスト ドキュメント (.txt)" Click="OnNewTextClick"/>
						<MenuItem Header="Markdown (.md)" Click="OnNewMarkdownClick"/>
						<MenuItem Header="JSON (.json)" Click="OnNewJsonClick"/>
						<MenuItem Header="CSV (.csv)" Click="OnNewCsvClick"/>
						<Separator/>
						<MenuItem Header="空の画像 (.png)" Click="OnNewPngClick"/>
						<MenuItem Header="Bitmap 画像 (.bmp)" Click="OnNewBmpClick"/>
						<Separator/>
						<MenuItem Header="圧縮 (zip) フォルダー" Click="OnNewZipClick"/>
						<Separator/>
						<MenuItem Header="既存ファイルをコピーして追加..." Click="OnImportFilesClick"/>
					</ContextMenu>
				</Button.ContextMenu>
			</Button>
		</StackPanel>

		<!-- 左ペイン：フォルダー ツリー -->
		<TreeView Grid.Row="1" Grid.Column="0" Margin="8,0,8,8"
				  ItemsSource="{Binding VM.Roots}"
				  SelectedItemChanged="OnFolderSelected"
				  TreeViewItem.Expanded="OnNodeExpanded"/>

		<!-- 右ペイン：ツールバー／ステータス -->
		<StackPanel Grid.Row="0" Grid.Column="1" Orientation="Horizontal" Margin="8,8,8,6">
			<Button Content="このフォルダを同期" Click="OnIndexCurrentFolderClick" Padding="10,4"/>
			<Button Content="差分のみIndex" Click="OnIndexOnlyUnindexedClick" Padding="10,4" Margin="8,0,0,0"/>
			<TextBlock Text="{Binding IndexStatusText}" Margin="16,4,0,0" VerticalAlignment="Center"/>
			<TextBlock Text="{Binding IndexedCountText}" Margin="16,4,0,0" VerticalAlignment="Center"/>
			<TextBlock Margin="16,4,0,0" VerticalAlignment="Center">
				<Run Text="鮮度 "/>
				<Run Text="{Binding FreshnessPercent, Mode=OneWay, StringFormat={}{0:F0}%}"/>
			</TextBlock>
		</StackPanel>

		<!-- インデックス進捗バー -->
		<ProgressBar Grid.Row="0" Grid.ColumnSpan="2" Height="4" VerticalAlignment="Bottom" Margin="8,0,8,0"
					 Maximum="100"
					 Value="{Binding IndexPercent, Mode=OneWay}"
					 Visibility="{Binding IsIndexing, Converter={StaticResource BoolToVis}}"/>

		<!-- 右ペイン：ファイル一覧 -->
		<DataGrid x:Name="FilesGrid"
				  Grid.Row="1" Grid.Column="1" Margin="8"
				  AutoGenerateColumns="False" IsReadOnly="True"
				  ItemsSource="{Binding Rows}"
				  MouseDoubleClick="OnFilesGridDoubleClick"
				  KeyDown="OnFilesGridKeyDown">
			<DataGrid.Columns>
				<DataGridTextColumn Header="名前" Binding="{Binding Name}" Width="*"/>
				<DataGridTextColumn Header="拡張子" Binding="{Binding Extension}" Width="100"/>
				<DataGridTextColumn Header="サイズ" Binding="{Binding Size, StringFormat={}{0:N0}}" Width="120"/>
				<DataGridTextColumn Header="更新日時" Binding="{Binding LastWriteTime, StringFormat={}{0:yyyy-MM-dd HH:mm}}" Width="170"/>

				<!-- 鮮度（絵文字＋色＋説明ツールチップ） -->
				<DataGridTemplateColumn Header="鮮度" Width="70">
					<DataGridTemplateColumn.CellTemplate>
						<DataTemplate>
							<TextBlock FontSize="16"
									   Text="{Binding FreshState, Converter={StaticResource FreshGlyph}}"
									   Foreground="{Binding FreshState, Converter={StaticResource FreshBrush}}"
									   HorizontalAlignment="Center" VerticalAlignment="Center">
								<TextBlock.ToolTip>
									<TextBlock Text="{Binding FreshState, Converter={StaticResource FreshTip}}"/>
								</TextBlock.ToolTip>
							</TextBlock>
						</DataTemplate>
					</DataGridTemplateColumn.CellTemplate>
				</DataGridTemplateColumn>
			</DataGrid.Columns>

			<DataGrid.RowStyle>
				<Style TargetType="DataGridRow">
					<Setter Property="ContextMenu">
						<Setter.Value>
							<ContextMenu>
								<!-- ★ 右クリックから「開く」 -->
								<MenuItem Header="開く" Click="OnOpenFileClick" CommandParameter="{Binding FullPath}"/>
								<Separator/>
								<MenuItem Header="このファイルを再Index" Click="OnReindexFileClick" CommandParameter="{Binding FullPath}"/>
								<MenuItem Header="DBから削除（レコードのみ）" Click="OnDeleteFromDbClick" CommandParameter="{Binding FullPath}"/>
								<Separator/>
								<MenuItem Header="エクスプローラーで場所を開く" Click="OnOpenLocationClick" CommandParameter="{Binding FullPath}"/>
							</ContextMenu>
						</Setter.Value>
					</Setter>
				</Style>
			</DataGrid.RowStyle>
		</DataGrid>
	</Grid>
</UserControl>
