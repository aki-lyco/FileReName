<Window x:Class="Explore.SettingsWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="設定"
        Height="600" Width="700"
        WindowStartupLocation="CenterOwner"
        ResizeMode="NoResize"
        Loaded="OnLoaded">
	<Grid>
		<Grid.RowDefinitions>
			<RowDefinition Height="*" />
			<RowDefinition Height="Auto" />
		</Grid.RowDefinitions>

		<!-- ===== 本文：タブ ===== -->
		<TabControl Grid.Row="0" Margin="12">
			<!-- ========== インデックス設定 ========== -->
			<TabItem Header="インデックス">
				<Border Padding="12">
					<StackPanel>
						<GroupBox Header="インデックス">
							<StackPanel Margin="8,8,8,0">
								<!-- コードビハインドで UiSettings と同期 -->
								<CheckBox x:Name="AutoIndexBox"
                                          Content="フォルダ選択時に自動インデックス" />
								<CheckBox x:Name="IncludeSubsBox"
                                          Content="サブフォルダを含める（インデックス時）"
                                          Margin="0,8,0,0" />
							</StackPanel>
						</GroupBox>

						<TextBlock Margin="0,12,0,0" Foreground="#666" TextWrapping="Wrap">
							これらの設定はフォルダ選択時の自動インデックス挙動に影響します。
							重いフォルダでの応答性が気になる場合は、自動インデックスを無効にするか、
							サブフォルダの含め方を調整してください。
						</TextBlock>
					</StackPanel>
				</Border>
			</TabItem>

			<!-- ========== 鮮度（Freshness） ========== -->
			<TabItem Header="鮮度">
				<ScrollViewer VerticalScrollBarVisibility="Auto">
					<Border Padding="16">
						<StackPanel>

							<TextBlock Text="鮮度（Freshness）状態一覧"
                                       FontSize="16" FontWeight="SemiBold" />
							<TextBlock Margin="0,6,0,0" TextWrapping="Wrap">
								ファイルとインデックス（DB）の同期状態を示す**状態**です。下表の基準で判定されます。
							</TextBlock>

							<!-- 表（指標 / 状態名 / 説明） -->
							<Border Margin="0,12,0,0" Padding="0"
                                    BorderBrush="#22000000" BorderThickness="1" CornerRadius="6">
								<Grid>
									<Grid.ColumnDefinitions>
										<ColumnDefinition Width="50" />
										<ColumnDefinition Width="160" />
										<ColumnDefinition Width="*" />
									</Grid.ColumnDefinitions>
									<Grid.RowDefinitions>
										<!-- ヘッダー + 6行 -->
										<RowDefinition Height="Auto"/>
										<RowDefinition Height="Auto"/>
										<RowDefinition Height="Auto"/>
										<RowDefinition Height="Auto"/>
										<RowDefinition Height="Auto"/>
										<RowDefinition Height="Auto"/>
										<RowDefinition Height="Auto"/>
									</Grid.RowDefinitions>

									<!-- ヘッダー -->
									<Border Grid.Row="0" Grid.ColumnSpan="3" Background="#0F000000" Padding="10,8">
										<Grid>
											<Grid.ColumnDefinitions>
												<ColumnDefinition Width="50"/>
												<ColumnDefinition Width="160"/>
												<ColumnDefinition Width="*"/>
											</Grid.ColumnDefinitions>
											<TextBlock Grid.Column="0" Text="指標" FontWeight="SemiBold"/>
											<TextBlock Grid.Column="1" Text="状態名" FontWeight="SemiBold"/>
											<TextBlock Grid.Column="2" Text="説明" FontWeight="SemiBold"/>
										</Grid>
									</Border>

									<!-- UpToDate -->
									<Border Grid.Row="1" Grid.ColumnSpan="3" BorderBrush="#11000000" BorderThickness="0,1,0,0" Padding="10,8">
										<Grid>
											<Grid.ColumnDefinitions>
												<ColumnDefinition Width="50"/>
												<ColumnDefinition Width="160"/>
												<ColumnDefinition Width="*"/>
											</Grid.ColumnDefinitions>
											<Ellipse Grid.Column="0" Width="10" Height="10" Fill="LimeGreen" VerticalAlignment="Center"/>
											<TextBlock Grid.Column="1" Text="UpToDate" FontWeight="SemiBold" VerticalAlignment="Center"/>
											<TextBlock Grid.Column="2" TextWrapping="Wrap"
                                                       Text="DBと実ファイルが一致しています。再インデックスは不要です。"/>
										</Grid>
									</Border>

									<!-- Stale -->
									<Border Grid.Row="2" Grid.ColumnSpan="3" BorderBrush="#11000000" BorderThickness="0,1,0,0" Padding="10,8">
										<Grid>
											<Grid.ColumnDefinitions>
												<ColumnDefinition Width="50"/>
												<ColumnDefinition Width="160"/>
												<ColumnDefinition Width="*"/>
											</Grid.ColumnDefinitions>
											<Ellipse Grid.Column="0" Width="10" Height="10" Fill="Goldenrod" VerticalAlignment="Center"/>
											<TextBlock Grid.Column="1" Text="Stale" FontWeight="SemiBold" VerticalAlignment="Center"/>
											<TextBlock Grid.Column="2" TextWrapping="Wrap"
                                                       Text="DBの情報と実物がズレています（更新日時やサイズの変化など）。再インデックスで一致します。"/>
										</Grid>
									</Border>

									<!-- Unindexed -->
									<Border Grid.Row="3" Grid.ColumnSpan="3" BorderBrush="#11000000" BorderThickness="0,1,0,0" Padding="10,8">
										<Grid>
											<Grid.ColumnDefinitions>
												<ColumnDefinition Width="50"/>
												<ColumnDefinition Width="160"/>
												<ColumnDefinition Width="*"/>
											</Grid.ColumnDefinitions>
											<Ellipse Grid.Column="0" Width="10" Height="10" Fill="SteelBlue" VerticalAlignment="Center"/>
											<TextBlock Grid.Column="1" Text="Unindexed" FontWeight="SemiBold" VerticalAlignment="Center"/>
											<TextBlock Grid.Column="2" TextWrapping="Wrap"
                                                       Text="ファイルは存在しますが、まだDBに登録されていません。インデックス実行で登録されます。"/>
										</Grid>
									</Border>

									<!-- Orphan -->
									<Border Grid.Row="4" Grid.ColumnSpan="3" BorderBrush="#11000000" BorderThickness="0,1,0,0" Padding="10,8">
										<Grid>
											<Grid.ColumnDefinitions>
												<ColumnDefinition Width="50"/>
												<ColumnDefinition Width="160"/>
												<ColumnDefinition Width="*"/>
											</Grid.ColumnDefinitions>
											<Ellipse Grid.Column="0" Width="10" Height="10" Fill="IndianRed" VerticalAlignment="Center"/>
											<TextBlock Grid.Column="1" Text="Orphan" FontWeight="SemiBold" VerticalAlignment="Center"/>
											<TextBlock Grid.Column="2" TextWrapping="Wrap"
                                                       Text="DBには記録がありますが、実ファイルが見つかりません。削除／移動された可能性があります。"/>
										</Grid>
									</Border>

									<!-- Indexing -->
									<Border Grid.Row="5" Grid.ColumnSpan="3" BorderBrush="#11000000" BorderThickness="0,1,0,0" Padding="10,8">
										<Grid>
											<Grid.ColumnDefinitions>
												<ColumnDefinition Width="50"/>
												<ColumnDefinition Width="160"/>
												<ColumnDefinition Width="*"/>
											</Grid.ColumnDefinitions>
											<Ellipse Grid.Column="0" Width="10" Height="10" Fill="SlateBlue" VerticalAlignment="Center"/>
											<TextBlock Grid.Column="1" Text="Indexing" FontWeight="SemiBold" VerticalAlignment="Center"/>
											<TextBlock Grid.Column="2" TextWrapping="Wrap"
                                                       Text="いまインデックス処理／鮮度計算を実行中です。"/>
										</Grid>
									</Border>

									<!-- Error -->
									<Border Grid.Row="6" Grid.ColumnSpan="3" BorderBrush="#11000000" BorderThickness="0,1,0,0" Padding="10,8">
										<Grid>
											<Grid.ColumnDefinitions>
												<ColumnDefinition Width="50"/>
												<ColumnDefinition Width="160"/>
												<ColumnDefinition Width="*"/>
											</Grid.ColumnDefinitions>
											<Ellipse Grid.Column="0" Width="10" Height="10" Fill="OrangeRed" VerticalAlignment="Center"/>
											<TextBlock Grid.Column="1" Text="Error" FontWeight="SemiBold" VerticalAlignment="Center"/>
											<TextBlock Grid.Column="2" TextWrapping="Wrap"
                                                       Text="アクセスできません。権限・パス・ロック状態などを確認してください。"/>
										</Grid>
									</Border>
								</Grid>
							</Border>

							<TextBlock Margin="0,10,0,0" Foreground="#666" TextWrapping="Wrap">
								※ 表示仕様は将来変更される場合があります。
							</TextBlock>
						</StackPanel>
					</Border>
				</ScrollViewer>
			</TabItem>

			<!-- ========== AI ========== -->
			<TabItem Header="AI">
				<ScrollViewer VerticalScrollBarVisibility="Auto">
					<Border Padding="16">
						<StackPanel>
							<TextBlock Text="Gemini API キー" FontSize="16" FontWeight="SemiBold"/>
							<TextBlock Foreground="#666" TextWrapping="Wrap" Margin="0,6,0,0">
								AI検索・分類などで使用する API キーを保存します。保存先は「ユーザー環境変数」または
								「アプリデータ（%APPDATA%\Explore\gemini_api_key.txt）」から選べます。
							</TextBlock>

							<!-- 保存先 -->
							<GroupBox Header="保存先" Margin="0,8,0,0">
								<StackPanel Margin="8,4,8,0">
									<RadioButton x:Name="StoreEnvRadio" Content="ユーザー環境変数（GEMINI_API_KEY）" IsChecked="True"/>
									<RadioButton x:Name="StoreFileRadio" Content="アプリデータに保存（%APPDATA%\Explore\gemini_api_key.txt）" Margin="0,4,0,0"/>
								</StackPanel>
							</GroupBox>

							<!-- API キー入力 -->
							<GroupBox Header="API キー" Margin="0,8,0,0">
								<Grid Margin="8">
									<Grid.RowDefinitions>
										<RowDefinition Height="Auto"/>
										<RowDefinition Height="Auto"/>
									</Grid.RowDefinitions>
									<Grid.ColumnDefinitions>
										<ColumnDefinition Width="*"/>
										<ColumnDefinition Width="Auto"/>
									</Grid.ColumnDefinitions>

									<!-- Password / Plain 切替 -->
									<PasswordBox x:Name="ApiKeyBox" Grid.Row="0" Grid.Column="0" Margin="0,0,8,0" />
									<TextBox x:Name="ApiKeyBoxPlain" Grid.Row="0" Grid.Column="0" Margin="0,0,8,0" Visibility="Collapsed"/>

									<CheckBox x:Name="ShowApiSwitch" Grid.Row="0" Grid.Column="1"
                                              Content="表示" VerticalAlignment="Center"
                                              Checked="OnShowApiChecked" Unchecked="OnShowApiChecked"/>

									<TextBlock x:Name="ApiSourceNote" Grid.Row="1" Grid.ColumnSpan="2"
                                               Foreground="#666" Margin="0,6,0,0" TextWrapping="Wrap"/>
								</Grid>
							</GroupBox>

							<TextBlock Foreground="#666" TextWrapping="Wrap" Margin="0,8,0,0">
								保存後、現在のアプリでは直ちに利用可能です（環境変数はこのプロセスにも反映します）。
								ほかのアプリ／古いプロセスでは再起動が必要な場合があります。
							</TextBlock>
						</StackPanel>
					</Border>
				</ScrollViewer>
			</TabItem>

			<!-- ========== データベース ========== -->
			<TabItem Header="データベース">
				<ScrollViewer VerticalScrollBarVisibility="Auto">
					<Border Padding="16">
						<StackPanel>

							<TextBlock Text="データベース情報" FontSize="16" FontWeight="SemiBold" />
							<TextBlock Foreground="#666" Margin="0,6,0,0" TextWrapping="Wrap">
								検索・AI機能が参照するインデックスDBの場所と件数を表示します。
							</TextBlock>

							<GroupBox Header="場所" Margin="0,8,0,0">
								<StackPanel Margin="8">
									<TextBlock Text="DB パス" FontWeight="SemiBold"/>
									<TextBlock x:Name="DbPathText" Margin="0,4,0,0" TextWrapping="Wrap"/>
								</StackPanel>
							</GroupBox>

							<GroupBox Header="件数" Margin="0,8,0,0">
								<Grid Margin="8">
									<Grid.RowDefinitions>
										<RowDefinition Height="Auto"/>
										<RowDefinition Height="Auto"/>
									</Grid.RowDefinitions>
									<Grid.ColumnDefinitions>
										<ColumnDefinition Width="200"/>
										<ColumnDefinition Width="*"/>
									</Grid.ColumnDefinitions>

									<TextBlock Grid.Row="0" Grid.Column="0" Text="files テーブル" FontWeight="SemiBold"/>
									<TextBlock x:Name="FileCountText" Grid.Row="0" Grid.Column="1" />

									<TextBlock Grid.Row="1" Grid.Column="0" Text="files_fts（あれば）" FontWeight="SemiBold" Margin="0,6,0,0"/>
									<TextBlock x:Name="FtsCountText" Grid.Row="1" Grid.Column="1" Margin="0,6,0,0"/>
								</Grid>
							</GroupBox>

							<StackPanel Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,8,0,0">
								<Button Content="再読み込み" Click="OnReloadCounts" Width="110"/>
							</StackPanel>

							<TextBlock Foreground="#666" Margin="0,8,0,0" TextWrapping="Wrap">
								件数が 0 の場合は、まず対象フォルダで「インデックス」を実行してください。
							</TextBlock>
						</StackPanel>
					</Border>
				</ScrollViewer>
			</TabItem>
		</TabControl>

		<!-- ===== フッター：ボタン ===== -->
		<StackPanel Grid.Row="1"
                    Orientation="Horizontal"
                    HorizontalAlignment="Right"
                    Margin="12">
			<Button Width="90" Margin="0,0,8,0"
                    Click="OnCancel"
                    IsCancel="True">キャンセル</Button>
			<Button Width="90"
                    Click="OnOK"
                    IsDefault="True">OK</Button>
		</StackPanel>
	</Grid>
</Window>
